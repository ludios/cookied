#!/usr/bin/env bash

set -eu -o pipefail

here=$(dirname -- "$0")
schema=$here/../../../schema
cookied=$here/../../cookied

DATABASE_URL=$(pg_tmp)
echo "ephemeralpg running at $DATABASE_URL"
echo

test_usernames=("one" "two")
test_passwords=("1" "2")

schema_name=$(grep -o -P -m 1 "^CREATE SCHEMA [\$_a-zA-Z0-9]+" "$schema"/schema.sql | cut -d " " -f 3)

psql -X "$DATABASE_URL" \
	-f "$schema"/extensions.sql \
	-f "$schema"/schema.sql

echo
echo "-- Log in with --"

for i in "${!test_usernames[@]}"; do
	username="${test_usernames[i]}"
	password="${test_passwords[i]}"
	hashed_password=$(echo -n "$password" | "$cookied"/dev/hash-password.mjs)
	psql -X --quiet "$DATABASE_URL" \
		-c "INSERT INTO $schema_name.users (username, hashed_password) VALUES ('$username', '$hashed_password')"
	echo " Username: $username"
	echo " Password: $password"
	echo
done

# https://www.prisma.io/docs/concepts/database-connectors/postgresql#arguments
export DATABASE_URL="$("$cookied"/dev/prisma-compatible-postgres-uri "$DATABASE_URL")&schema=$schema_name"

export SESSION_COOKIE_NAME=s
export SESSION_COOKIE_PATH=/
export SESSION_COOKIE_SECURE=0

./node_modules/.bin/vite dev --host
