#!/usr/bin/env bash

set -eu -o pipefail

here=$(dirname -- "$0")
schema=$here/../../../schema

DATABASE_URL=$(pg_tmp)
echo "ephemeralpg running at $DATABASE_URL"
echo

schema_name=$(grep -o -P -m 1 "^CREATE SCHEMA [\$_a-zA-Z0-9]+" "$schema"/schema.sql | cut -d " " -f 3)

psql -X "$DATABASE_URL" \
	-f "$schema"/extensions.sql \
	-f "$schema"/schema.sql

# https://www.prisma.io/docs/concepts/database-connectors/postgresql#arguments
export DATABASE_URL="$("$here"/prisma-compatible-postgres-uri "$DATABASE_URL")&schema=$schema_name"

# --force does not correctly preserve sessions_view.
# https://www.prisma.io/docs/concepts/components/prisma-schema/views#adding-a-unique-identifier-to-an-introspected-view
#$here/../node_modules/.bin/prisma db pull --force

"$here"/../node_modules/.bin/prisma db pull

# Need node_modules/bin/ in PATH to fix:
# /bin/sh: line 1: prisma-pothos-types: command not found
PATH="$here"/../node_modules/.bin:"$PATH" "$here"/../node_modules/.bin/prisma generate
